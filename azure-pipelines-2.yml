trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# 1. Exchange the token.
- task: JfrogCliV2@1
  name: jfAuth
  inputs:
    jfrogPlatformConnection: 'serviceconnection' # Ensure this connection is set to 'OIDC' in Azure
    command: 'jf rt ping'

# 2. Use the token in a follow-up step
- bash: |
    echo "Starting download..."
    
    # Check if the token variable exists at all
    if [ -z "$OIDC_TOKEN" ]; then
      echo "ERROR: OIDC_TOKEN environment variable is empty."
      exit 1
    fi

    # Optional: Log first 10 chars for debugging (Never log the full token!)
    echo "Token preview: ${OIDC_TOKEN:0:10}..."

    curl -fL -H "Authorization: Bearer $OIDC_TOKEN" \
         "https://hts2.jfrog.io/artifactory/sharanya-oidc/1mb.zip" \
         -o "1mb.zip"

    echo "Download success!"
  displayName: 'OIDC Curl Download'
  env:
    # Mapping the output variable from the 'jfAuth' task
    OIDC_TOKEN: $(jfAuth.oidc_token)